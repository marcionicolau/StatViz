<!-- Skeleton for VizStat -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="style/skeleton.css">
        <link rel="stylesheet" type="text/css" href="style/visualizations.css">
        <meta charset="utf-8">
        
<!--         Title - change if possible -->
        <title>StatViz</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        
        <script type="text/javascript" src="JS/mouse.js"></script>
        
        <script type="text/javascript" src="JS/histogram.js"></script>
        <script type="text/javascript" src="JS/boxplot.js"></script>
        <script type="text/javascript" src="JS/scatterplot.js"></script>
        <script type="text/javascript" src="JS/scatterplot matrix.js"></script>
        
        <script type="text/javascript" src="JS/statistical-tests.js"></script>
        
        <script type="text/javascript" src="JS/helper.js"></script>
        <script type="text/javascript" src="JS/math.js"></script>
        <script type="text/javascript" src="JS/settings.js"></script>
        
        <script src="opencpu/jquery-1.10.1.min.js"></script>
        <script src="opencpu/opencpu.js"></script>
    </head>
    <body>        
        <script type="text/javascript">            
            
// Define format for displaying text (this depends on the dataset)            
            var format = d3.format(".1f");	
            
//  Global variables that store statistics
            var variables = new Object();     
            var IQR = new Object();   
            var MIN = new Object();
            var MAX = new Object();
            
            var currentVariableSelection = [];
            var currentVisualizationSelection = "Histogram"; //by default
        
            window.onload = function()
            { 
                InitMouseGestures();
                
                // Set the width and height of panels
                variablePanel = d3.select("#variable.panel");
                visualizationPanel = d3.select("#visualization.panel");
                
                canvas = d3.select("#canvas");
        
                variablePanel.attr("style", "width: " + (width - canvasWidth) + "px; height: " + height + "px;");    
                visualizationPanel.attr("style", "width: " + canvasWidth + "px; height: " + height/3 + "px; top: " + canvasHeight + "px; left: " + (width - canvasWidth) + "px;");    
                canvas.attr("style", "position: absolute; width: " + canvasWidth + "px; height: " + canvasHeight + "px; top: 0px; left: " + (width - canvasWidth) + "px;");    
                
                // Load data from a given file
                loadFile("/Users/krishnasubramanian/Documents/Coursera/Statistics One/Datasets/datafiles-Stats1.13.Lab.04.txt");
                
                // Load dataset variables and their data (into global variable "variables") and IQR (into IQR)
//                 getVariables(dataset);
                
                // Populate visualizations
//                 renderVisualizations();                
            }
            
            function loadFile(filePath)
            {
                var req = opencpu.r_fun_json("loadFile", {
                                filePath: filePath
                              }, function(output) {                   
                dataset = output.data;
                varNames = output.variableNames;
                
                console.log("variables in the dataset: " + varNames);
                 }).fail(function(){
                      alert("Failure: " + req.responseText);
                });
        
                //if R returns an error, alert the error message
                req.fail(function(){
                  alert("Server error: " + req.responseText);
                }); 
            }
                
            function getVariables(dataset)
            {   
                // Get variable names and their data type
                var req = opencpu.r_fun_json("getVariableNames", {
                                dataset: dataset
                              }, function(output) {                   
                renderVariableNames(output.varNames);
                for(var i=0; i<output.varNames.length; i++)
                {
                    getData(dataset, output.varNames[i]);                 
                    getIQR(dataset, output.varNames[i]);                    
                } }).fail(function(){
                      alert("Failure: " + req.responseText);
                });
        
                //if R returns an error, alert the error message
                req.fail(function(){
                  alert("Server error: " + req.responseText);
                });   
            }
            
            function getData(dataset, variableName)
            {
                // Get variable names and their data type
                var req = opencpu.r_fun_json("getData", {
                                dataset: dataset,
                                columnName: variableName
                              }, function(output) {                                 
                variables[variableName] = output.data; 
                MIN[variableName] = Array.min(output.data);
                MAX[variableName] = Array.max(output.data);                               
                  }).fail(function(){
                      alert("Failure: " + req.responseText);
                });
        
                //if R returns an error, alert the error message
                req.fail(function(){
                  alert("Server error: " + req.responseText);
                });
                req.complete(function(){
                    
                });
            }
            
            function getIQR(dataset, variableName)
            {
                // Get variable names and their data type
                var req = opencpu.r_fun_json("getIQR", {
                                dataset: dataset,
                                columnName: variableName
                              }, function(output) {                                 
                IQR[variableName] = output.IQR;                                
                  }).fail(function(){
                      alert("Failure: " + req.responseText);
                });
        
                //if R returns an error, alert the error message
                req.fail(function(){
                  alert("Server error: " + req.responseText);
                });
                req.complete(function(){
                    
                });
            }
            
            function renderVariableNames(variableNames)
            {   
                var variablePanel = d3.select("#variable.panel");                
                var variablePanelWidth = variablePanel.style("width");
                
                var variableNameHolderPadding = 15;
                var radius = "15px";
                var variableNameHolderWidth = getNumber(variablePanelWidth) - 2*variableNameHolderPadding;                
                
                // TODO: Find this dynamically based on number of variable names (75 is the maximum), do this for font-size as well
                var variableNameHolderHeight = 50;
                
                var variablePanelSVG = variablePanel.append("svg");                
                variablePanelSVG.attr("id","variablePanelSVG")
                                            .attr("height", variablePanel.style("height"))
                                            .attr("width", variablePanelWidth)
                                            .attr("left", variablePanel.style("left"))
                                            .attr("top", variablePanel.style("top"));  
                
                var imageSize = 50;
                
                flags = [0,0,1,0,0,0,1];
                imageNames = ["knob-independent-variable.png", "meter-dependent-variable-alternative.png"];
                
                var displayNames = variableNames;
                
                for(var i=0; i<variableNames.length; i++)
                {
                    variableNames[i] = processStrings(variableNames[i]);
                    variablePanelSVG.append("rect")
                                                    .attr("x", variableNameHolderPadding)
                                                    .attr("y", variableNameHolderPadding + i*(variableNameHolderHeight + variableNameHolderPadding))                                                   
                                                    .attr("height", variableNameHolderHeight)
                                                    .attr("width",  variableNameHolderWidth)     
                                                    .attr("rx", radius)
                                                    .attr("ry", radius)
                                                    .attr("fill", panelColors.normal)
                                                    .attr("id", variableNames[i])
                                                    .attr("class", "variableNameHolder");

                                                
                    variablePanelSVG.append("text")
                                                    .attr("x", variableNameHolderPadding + variableNameHolderWidth/2)
                                                    .attr("y", variableNameHolderPadding + variableNameHolderHeight/2 + 15 + i*(variableNameHolderHeight + variableNameHolderPadding))
                                                    .attr("fill", "black")
                                                    .attr("font-size", "36px")
                                                    .attr("text-anchor", "middle")
                                                    .text(variableNames[i])
                                                    .attr("id", variableNames[i])
                                                    .attr("class", "variableNameHolder");
                                                    
//                     variablePanelSVG.append("image")
//                                                     .attr("x", variableNameHolderPadding + variableNameHolderWidth - imageSize - 15)
//                                                     .attr("y", variableNameHolderPadding + variableNameHolderHeight/5 + i*(variableNameHolderHeight + variableNameHolderPadding))
//                                                     .attr("xlink:href", "images/" + imageNames[flags[i]])
//                                                     .attr("height", imageSize)
//                                                     .attr("width", imageSize)
//                                                     .attr("id", variableNames[i])
//                                                     .attr("class", "variableNameHolder");
                }    
                
                                     
            }
            
            function renderVisualizations()
            {
                visualizationPanel = d3.select("#visualization.panel");
                var visualizationPanelHeight = visualizationPanel.style("height");
                var visualizationPanelWidth = visualizationPanel.style("width");
                
                var visualizationHolderPadding = 15;
                var radius = "15px";
                var visualizationHolderHeight = getNumber(visualizationPanelHeight) - 2*visualizationHolderPadding;                
                
               
                
                var visualizationPanelSVG = visualizationPanel.append("svg");                
                visualizationPanelSVG.attr("id","visualizationPanelSVG")
                                            .attr("height", visualizationPanelHeight)
                                            .attr("width", visualizationPanelWidth)
                                            .attr("left", visualizationPanel.style("left"))
                                            .attr("top", visualizationPanel.style("top"));  
                
                var visualizations = ["Histogram", "Boxplot", "Scatterplot", "Scatterplot-matrix"];
                 // TODO: Find this dynamically based on number of variable names (75 is the maximum), do this for font-size as well
                var visualizationHolderWidth = (getNumber(visualizationPanelWidth) - (visualizations.length+1)*visualizationHolderPadding)/(visualizations.length);
                
                var imageSize = 200;
                
                for(var i=0; i<visualizations.length; i++)
                {                    
                    visualizationPanelSVG.append("rect")
                                                    .attr("x", visualizationHolderPadding + i*(visualizationHolderWidth + visualizationHolderPadding))
                                                    .attr("y", visualizationHolderPadding )
                                                    .attr("height", visualizationHolderHeight)
                                                    .attr("width",  visualizationHolderWidth)     
                                                    .attr("rx", radius)
                                                    .attr("ry", radius)
                                                    .attr("id", visualizations[i])
                                                    .attr("fill", panelColors.normal)
                                                    .attr("class", "visualizationHolder");
                    
                    visualizationPanelSVG.append("image")
                                                    .attr("x", visualizationHolderPadding + visualizationHolderWidth/2 - imageSize/2 + i*(visualizationHolderWidth + visualizationHolderPadding))
                                                    .attr("y", visualizationHolderPadding + visualizationHolderHeight/2 - imageSize/2)
                                                    .attr("xlink:href", "images/" + (i+1) + ".png")
                                                    .attr("height", imageSize)
                                                    .attr("width", imageSize)
                                                    .attr("style", "opacity: 0.75;")
                                                    .attr("id", visualizations[i])
                                                    .attr("class", "visualizationHolderImage");
                                                
                    visualizationPanelSVG.append("text")
                                                    .attr("x", visualizationHolderPadding + visualizationHolderWidth/2 + i*(visualizationHolderWidth + visualizationHolderPadding))
                                                    .attr("y", visualizationHolderPadding + visualizationHolderHeight/2)
                                                    .attr("fill", "black")
                                                    .attr("font-size", "36px")
                                                    .attr("text-anchor", "middle")
                                                    .text(visualizations[i])
                                                    .attr("id", visualizations[i])
                                                    .attr("class", "visualizationHolderText");
                                                    
                } 
            }       
                
            
           
        </script>
        
        <div id="variable" class="panel"></div>
        <div id="visualization" class="panel"></div>
        <div id="canvas"></div>        

    </body>
</html>   
